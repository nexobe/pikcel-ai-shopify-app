#
# DigitalOcean App Platform Specification
# PikcelAI Shopify App - Production Configuration
#
# This file defines the infrastructure and deployment configuration for the
# PikcelAI Shopify app on DigitalOcean App Platform.
#
# Documentation: https://docs.digitalocean.com/products/app-platform/reference/app-spec/
#

name: pikcel-ai-shopify-app
region: nyc

# Services
services:
  - name: web
    # Git repository configuration
    github:
      repo: nexobe/pikcel-ai-shopify-app
      branch: main
      deploy_on_push: true

    # Build configuration
    build_command: npm run build

    # Runtime configuration
    run_command: npm start

    # Dockerfile build (alternative to buildpack)
    # Uncomment to use Dockerfile instead of buildpack
    # dockerfile_path: Dockerfile

    # Node.js runtime environment
    environment_slug: node-js

    # Instance size and scaling
    instance_count: 1
    instance_size_slug: basic-xxs

    # HTTP configuration
    http_port: 8080

    # Environment variables
    envs:
      # Node environment
      - key: NODE_ENV
        value: production
        scope: RUN_TIME
        type: GENERAL

      # Port configuration (DigitalOcean uses 8080)
      - key: PORT
        value: "8080"
        scope: RUN_TIME
        type: GENERAL

      # Backend URL
      - key: BACKEND_URL
        value: ${APP_URL}
        scope: RUN_TIME
        type: GENERAL

      # Shopify API credentials (set via CLI or control panel)
      - key: SHOPIFY_API_KEY
        scope: RUN_TIME
        type: SECRET

      - key: SHOPIFY_API_SECRET
        scope: RUN_TIME
        type: SECRET

      # Shopify app configuration
      - key: SHOPIFY_APP_URL
        value: ${APP_URL}
        scope: RUN_TIME
        type: GENERAL

      - key: SHOPIFY_SCOPES
        value: "read_products,write_products,read_files,write_files"
        scope: RUN_TIME
        type: GENERAL

      # Supabase Database (PikcelAI existing database)
      - key: DATABASE_URL
        value: "postgresql://postgres.cvzkmmxdbkjhgfongupg:TughrulAsghar1986!@db.cvzkmmxdbkjhgfongupg.supabase.co:5432/postgres"
        scope: RUN_AND_BUILD_TIME
        type: SECRET

      # Supabase Configuration (use existing PikcelAI Supabase)
      - key: SUPABASE_URL
        value: "https://cvzkmmxdbkjhgfongupg.supabase.co"
        scope: RUN_TIME
        type: GENERAL

      - key: SUPABASE_ANON_KEY
        value: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2emttbXhkYmtqaGdmb25ndXBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwMzI5MDAsImV4cCI6MjA1NjYwODkwMH0.LXkRVCSaB1IhXP7-y1kWdJ8GKqAZYUaibzRhNVr7BpI"
        scope: RUN_TIME
        type: SECRET

      - key: SUPABASE_SERVICE_KEY
        value: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2emttbXhkYmtqaGdmb25ndXBnIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MTAzMjkwMCwiZXhwIjoyMDU2NjA4OTAwfQ.OI50eGUYsU_VMBGq6M6oPJoy-a5dfrgdgc3eSgklwxM"
        scope: RUN_TIME
        type: SECRET

      # Session encryption key (generate with: openssl rand -base64 32)
      - key: SHOPIFY_APP_SESSION_SECRET
        scope: RUN_TIME
        type: SECRET

    # Health check configuration
    health_check:
      http_path: /healthz
      initial_delay_seconds: 60
      period_seconds: 10
      timeout_seconds: 3
      success_threshold: 1
      failure_threshold: 3

    # Routes configuration
    routes:
      - path: /

# Jobs (for database migrations - uses PikcelAI Supabase database)
jobs:
  - name: db-migrate
    kind: PRE_DEPLOY

    github:
      repo: nexobe/pikcel-ai-shopify-app
      branch: main

    environment_slug: node-js

    run_command: npm run setup

    envs:
      - key: DATABASE_URL
        value: "postgresql://postgres.cvzkmmxdbkjhgfongupg:TughrulAsghar1986!@db.cvzkmmxdbkjhgfongupg.supabase.co:5432/postgres"
        scope: RUN_TIME
        type: SECRET

      - key: NODE_ENV
        value: production
        scope: RUN_TIME
        type: GENERAL

# Alerts (optional)
# alerts:
#   - rule: DEPLOYMENT_FAILED
#   - rule: DOMAIN_FAILED
#   - rule: SERVICE_UNHEALTHY
